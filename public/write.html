<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>&#xAE00;&#xC4F0;&#xAE30; - Fireboard</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/runtime-config.js"></script>
  <style>
    .image-preview {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .image-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap hd-inner">
      <a href="/" class="logo">Fireboard 2026</a>
      <nav class="gnb">
        <a href="/board.html?category=notice">&#xACF5;&#xC9C0;&#xC0AC;&#xD56D;</a>
        <a href="/board.html?category=free">&#xC790;&#xC720;&#xAC8C;&#xC2DC;&#xD310;</a>
        <a href="/board.html?category=qna">Q&A</a>
        <a href="/board.html?category=gallery">&#xAC24;&#xB7EC;&#xB9AC;</a>
      </nav>
    </div>
  </header>

  <div class="wrap container">
    <h2 class="page-title">&#xAE00;&#xC4F0;&#xAE30;</h2>

    <form id="write-form">
      <div style="margin-bottom:10px;">
        <label for="category" style="display:block; margin-bottom:5px; font-weight:600;">&#xCE74;&#xD14C;&#xACE0;&#xB9AC;</label>
        <select id="category" required>
          <option value="notice">&#xACF5;&#xC9C0;&#xC0AC;&#xD56D;</option>
          <option value="free">&#xC790;&#xC720;&#xAC8C;&#xC2DC;&#xD310;</option>
          <option value="qna">Q&A</option>
          <option value="gallery">&#xAC24;&#xB7EC;&#xB9AC;</option>
        </select>
      </div>

      <div style="margin-bottom:10px;">
        <label for="title" style="display:block; margin-bottom:5px; font-weight:600;">&#xC81C;&#xBAA9;</label>
        <input type="text" id="title" required placeholder="&#xAC8C;&#xC2DC;&#xAE00; &#xC81C;&#xBAA9;&#xC744; &#xC785;&#xB825;&#xD558;&#xC138;&#xC694;">
      </div>

      <div style="margin-bottom:10px;">
        <label for="price" style="display:block; margin-bottom:5px; font-weight:600;">&#xAC00;&#xACA9;</label>
        <input type="number" id="price" required placeholder="0" min="0">
      </div>

      <div style="margin-bottom:10px;">
        <label for="content" style="display:block; margin-bottom:5px; font-weight:600;">&#xB0B4;&#xC6A9;</label>
        <textarea id="content" required placeholder="&#xAC8C;&#xC2DC;&#xAE00; &#xB0B4;&#xC6A9;&#xC744; &#xC785;&#xB825;&#xD558;&#xC138;&#xC694;" style="height:300px;"></textarea>
      </div>

      <div style="margin-bottom:20px;">
        <label for="images" style="display:block; margin-bottom:5px; font-weight:600;">&#xC774;&#xBBF8;&#xC9C0; (&#xCD5C;&#xB300; 3&#xC7A5;)</label>
        <input type="file" id="images" accept="image/*" multiple>
        <div id="image-preview" class="image-preview"></div>
      </div>

      <div class="error-message" id="error-message"></div>

      <div style="display:flex; justify-content:space-between; align-items:center;">
        <button type="button" class="btn btn-gray" id="cancel-btn">&#xCDE8;&#xC18C;</button>
        <button type="submit" class="btn">&#xB4F1;&#xB85D;</button>
      </div>
    </form>
  </div>

  <footer>
    <div class="wrap">
      <p>&copy; 2026 Fireboard. All rights reserved.</p>
    </div>
  </footer>

  <script type="module">
    import { waitForAuth } from '/js/firebase-init.js';
    import { createPost } from '/js/posts.js';

    // Wait for auth check
    const user = await waitForAuth();
    if (!user) {
      alert('로그인이 필요합니다.');
      window.location.href = '/login.html';
    }

    const form = document.getElementById('write-form');
    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('image-preview');
    const errorMsg = document.getElementById('error-message');

    document.getElementById('cancel-btn').addEventListener('click', () => {
      history.back();
    });

    imageInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files).slice(0, 3);
      imagePreview.innerHTML = '';

      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement('img');
          img.src = event.target.result;
          imagePreview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '\ub4f1\ub85d \uc911..';

      try {
        const postData = {
          title: document.getElementById('title').value,
          content: document.getElementById('content').value,
          price: document.getElementById('price').value,
          category: document.getElementById('category').value
        };

        const images = Array.from(imageInput.files).slice(0, 3);
        await createPost(postData, images);
        alert('\uac8c\uc2dc\uae00\uc774 \ub4f1\ub85d\ub418\uc5c8\uc2b5\ub2c8\ub2e4.');
        window.location.href = '/';
      } catch (error) {
        console.error('Post creation error:', error);
        errorMsg.textContent = '\uac8c\uc2dc\uae00 \ub4f1\ub85d \uc911 \uc624\ub958\uac00 \ubc1c\uc0dd\ud588\uc2b5\ub2c8\ub2e4.';
        errorMsg.classList.add('show');
        submitBtn.disabled = false;
        submitBtn.textContent = '\ub4f1\ub85d';
      }
    });
  </script>
</body>
</html>
